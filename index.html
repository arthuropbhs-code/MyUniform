function updatePreview() {
    const container = document.getElementById('u-ribbons');
    const mContainer = document.getElementById('u-medals');
    const aContainer = document.getElementById('u-arcs');

    if (!container) return;

    const sortedActive = [...OFFICIAL_RIBBONS, ...POMPANO_RIBBONS]
        .filter(r => state.ribbons.has(r.id))
        .sort((a, b) => a.precedence - b.precedence);

    if (sortedActive.length === 0) {
        container.innerHTML = '<div class="text-slate-600 text-xs italic">No ribbons added</div>';
        if (mContainer) mContainer.innerHTML = '';
        if (aContainer) aContainer.innerHTML = '';
        return;
    }

    // Build rows bottom-up
    const rows = [];
    let index = sortedActive.length;

    while (index > 0) {
        const start = Math.max(index - 3, 0);
        rows.push(sortedActive.slice(start, index));
        index = start;
    }

    container.innerHTML = '';

    // Render bottom row first so rack grows upward
    rows.forEach(rowItems => {
        const rowDiv = document.createElement('div');
        rowDiv.className = "flex gap-[1.5px] justify-center";

        rowItems.forEach(r => {
            const d = document.createElement('div');
            d.className = 'ribbon-mini';
            d.style.backgroundImage = `url(${r.img})`;

            const count = state.ribbons.get(r.id);
            if (count > 1) {
                const s = document.createElement('div');
                s.className = 'mini-star';
                s.innerText = 'â˜…'.repeat(count - 1);
                d.appendChild(s);
            }

            rowDiv.appendChild(d);
        });

        container.appendChild(rowDiv);
    });

    // Medals
    if (mContainer) {
        mContainer.innerHTML = '';
        MEDALS.filter(m => state.medals.has(m.id)).forEach(() => {
            const d = document.createElement('div');
            d.className = 'medal-mini h-8 w-5 bg-yellow-600 border border-black';
            mContainer.appendChild(d);
        });
    }

    // Arcs
    if (aContainer) {
        aContainer.innerHTML = '';
        ARCS.filter(a => state.arcs.has(a.id)).forEach(a => {
            const d = document.createElement('div');
            d.className = 'arc-mini px-2 py-0.5 text-[8px] bg-slate-800 border border-yellow-500 rounded-sm';
            d.innerText = a.name;
            aContainer.appendChild(d);
        });
    }
}
